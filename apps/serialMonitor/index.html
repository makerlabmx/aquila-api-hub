<!doctype html>
<html>
<head>
  <title>Aquila Serial Console</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css">
  <style>
    body 		{ padding-top:10px; word-wrap:break-word; }
    #console_output { min-width: 100%; min-height: 400px; max-height: 400px; white-space: pre-wrap; overflow: auto; }
  </style>

  <script src="https://code.jquery.com/jquery-2.1.2.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <script>
    var socket = io.connect('/wserial',{query: "token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6IjU0NmFhMWM5NjJjNmQ2NjcyY2I0N2E1ZiIsInVzZXIiOiJBZG1pbiIsImlhdCI6MTQxNjI3OTY3Mn0.w75vfvMZ8cDZLUCYUVgmsA4kP2x0RB72qhUOz4MbAPc"});

    var lastSender = 0;

    $(document).ready(function()
      {
        console.log("JQuery ready");
        socket.on("data", function(data)
        {
          console.log(data);
          if(data.srcAddr !== lastSender)
            {
              lastSender = data.srcAddr;
              var legend = "FROM " + lastSender + ":\n";
              $("#console_output").append(legend);
            }

          $("#console_output").text($("#console_output").text() + data.data.replace("\r", "\n")); // fix CR in pre
          $("#console_output").scrollTop($('#console_output')[0].scrollHeight);
        });

        socket.on("err", function(error)
          {
            console.log(error);
          });

        $("#clear_button").on("click", function()
          {
            $("#console_output").html("");
          });

        $("#send_button").on("click", function()
          {
            var message = {
              dstAddr: parseInt($("#addr_input").val()),
              data: $("#send_input").val()
            };
            console.log(message);
            socket.emit("data", message);
          });
      });
  </script>

</head>
<body>
  <div class="container">

    <div class="page-header text-center">
      <h1>Serial Console</h1>
    </div>

    <div class="row">
      <label for="send_input">Enviar:</label>
      <input type="text" name="send_input" id="send_input" value="">

      <label for="addr_input">A:</label>
      <input type="text" name="addr_input" id="addr_input" value="">

      <input type="button" name="send_button" id="send_button" value="Send">

      <div id="output_div">
        <pre id="console_output"></pre>
      </div>
      <button name="clear_button" id="clear_button">Clear</button>

    </div>

  </div>
</body>
</html>
